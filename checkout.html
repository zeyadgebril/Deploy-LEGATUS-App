<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - Luxury Watch Store</title>
    <link rel="icon" href="./images/web icon.png" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />

    <!-- access control -->
    <script type="module" src="../Sign/Initialize.js"></script>

    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
    <!--FontAwesome  -->
    <!-- nav -->
    <link rel="stylesheet" href="nav.css" />
    <script src="navFoterManager.js" type="module"></script>
    <style>
      :root {
        --nav_color: #002f5f;
        --primary-color: #002f5f;
        --secondary-color: #3d5a8a;
        --light-bg: #f5f7f6;
        --text-color: #2b2d42;
        --border-radius: 8px;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--light-bg);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      /* Top Bar */
      .top-bar {
        background-color: #dae5ef;
        color: var(--primary-color);
        font-size: 0.9rem;
        padding: 0.3rem 0;
      }

      /* Navbar */

      /* Checkout Header */
      .checkout-header {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        padding: 30px 0;
        margin-bottom: 30px;
        color: white;
        text-align: center;
      }

      .checkout-header h1 {
        font-weight: 600;
        font-size: 2.2rem;
        margin: 0;
      }

      /* Progress Steps */
      .checkout-progress {
        display: flex;
        justify-content: center;
        margin: 25px auto 0;
        max-width: 600px;
      }
      .progress-step {
        flex: 1;
        text-align: center;
        position: relative;
        padding: 0 10px;
      }

      .progress-step::before {
        content: "";
        height: 3px;
        background-color: rgba(255, 255, 255, 0.5);
        position: absolute;
        top: 15px;
        left: 0;
        right: 0;
        z-index: 1;
      }

      .progress-step:first-child::before {
        left: 50%;
      }

      .progress-step:last-child::before {
        right: 50%;
      }

      .step-icon {
        width: 34px;
        height: 34px;
        background-color: white;
        color: var(--primary-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        position: relative;
        z-index: 2;
        font-size: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .step-text {
        font-size: 0.85rem;
        white-space: nowrap;
        color: rgba(255, 255, 255, 0.9);
      }

      .active-step .step-icon {
        background-color: #4cc9f0;
        color: white;
      }

      .active-step .step-text {
        font-weight: bold;
        color: white;
      }

      .completed-step .step-icon {
        background-color: white;
        color: #4cc9f0;
      }
      /* Shipping Options */
      .shipping-options {
        border: 1px solid #eee;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .shipping-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 15px;
      }

      /* Cards */
      .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        margin-bottom: 30px;
        background-color: white;
      }

      .card-header {
        background-color: white;
        padding: 20px;
        border-bottom: 1px solid #eee;
      }

      .card-header h3 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--primary-color);
        display: flex;
        align-items: center;
      }

      .card-header h3 i {
        margin-right: 10px;
        background-color: var(--light-bg);
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        color: var(--primary-color);
      }

      /* Form Styles */
      .form-label {
        font-weight: 500;
        color: #555;
      }

      .required-field::after {
        content: " *";
        color: #dc3545;
        font-weight: normal;
      }

      .form-control,
      .form-select {
        padding: 12px 15px;
        border-radius: var(--border-radius);
        border: 1px solid #ddd;
        transition: border-color 0.2s;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(0, 47, 95, 0.1);
      }

      /* Buttons */
      .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        padding: 12px 20px;
        font-weight: 500;
        border-radius: var(--border-radius);
        transition: all 0.2s;
      }

      .btn-primary:hover {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      /* Product Items */
      .product-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
      }

      .product-item:last-child {
        border-bottom: none;
      }

      .product-image {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border-radius: var(--border-radius);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-right: 15px;
      }

      .product-details {
        flex: 1;
      }

      .product-details h6 {
        margin-bottom: 5px;
        font-weight: 600;
      }

      /* Order Summary */
      .order-summary {
        background-color: #f8f9fa;
        border-radius: var(--border-radius);
        padding: 20px;
      }

      .order-summary h5 {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--primary-color);
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        color: #555;
      }

      .summary-divider {
        border-top: 1px solid #ddd;
        margin: 10px 0;
      }

      .total-price {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--primary-color);
        padding-top: 10px;
      }

      /* Security Notice */
      .security-notice {
        display: flex;
        align-items: center;
        margin-top: 20px;
        padding: 10px;
        border-radius: var(--border-radius);
        background-color: rgba(76, 201, 240, 0.1);
        color: #555;
      }

      .security-notice i {
        font-size: 18px;
        margin-right: 10px;
        color: #4cc9f0;
      }

      /* Help Section */
      .help-section {
        background-color: white;
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .help-section h5 {
        color: var(--primary-color);
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }

      .help-section h5 i {
        margin-right: 10px;
      }

      .help-item {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }

      .help-icon {
        min-width: 40px;
        height: 40px;
        background-color: var(--light-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: var(--primary-color);
      }

      .help-text h6 {
        margin: 0 0 5px;
        font-weight: 600;
      }

      .help-text p {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
      }

      /* Footer */
      .footer {
        background-color: var(--nav_color);
        color: white;
        margin-top: auto;
      }

      .footer a:hover {
        color: #bdc3c7 !important;
      }

      /* Responsive Adjustments */
      @media (max-width: 767px) {
        .checkout-header h1 {
          font-size: 1.8rem;
        }

        .step-text {
          font-size: 0.7rem;
        }

        .card-header h3 {
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Bar -->
    <div class="top-bar py-1">
      <div class="container d-flex justify-content-center">
        <div>Fast & Secure Shopping | Professional Packaging</div>
      </div>
    </div>

    <!-- Navbar -->
    <special-nav></special-nav>
    <!-- Checkout Header with Progress Bar -->
    <div class="checkout-header">
      <div class="container">
        <h1>Checkout</h1>
        <div class="checkout-progress">
          <div class="progress-step completed-step">
            <div class="step-icon">
              <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="step-text">Cart</div>
          </div>
          <div class="progress-step active-step">
            <div class="step-icon">
              <i class="fas fa-address-card"></i>
            </div>
            <div class="step-text">Details</div>
          </div>
          <div class="progress-step">
            <div class="step-icon">
              <i class="fas fa-credit-card"></i>
            </div>
            <div class="step-text">Payment</div>
          </div>
          <div class="progress-step">
            <div class="step-icon">
              <i class="fas fa-check"></i>
            </div>
            <div class="step-text">Confirmation</div>
          </div>
        </div>
      </div>
    </div>

    <div class="container mb-5">
      <div class="row">
        <!-- Billing & Shipping Section -->
        <div class="col-lg-7">
          <div class="card">
            <div class="card-header">
              <h3>
                <i class="fas fa-map-marker-alt"></i> Shipping Information
              </h3>
            </div>
            <div class="card-body p-4">
              <form id="checkoutForm">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="fullName" class="form-label required-field"
                      >Full Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="fullName"
                      placeholder="Enter your full name"
                      required
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="phoneNumber" class="form-label required-field"
                      >Phone Number</label
                    >
                    <input
                      type="tel"
                      class="form-control"
                      id="phoneNumber"
                      placeholder="Enter your phone number"
                      required
                      pattern="^\d{10,15}$"
                      title="Please enter a valid phone number (10 to 15 digits)"
                    />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="country" class="form-label required-field"
                      >Country/Region</label
                    >
                    <select class="form-select" id="country" required>
                      <option value="" disabled selected>
                        Select Your Country
                      </option>
                      <option value="EG">Egypt</option>
                      <option value="US">United States</option>
                      <option value="UK">United Kingdom</option>
                      <option value="AE">United Arab Emirates</option>
                      <option value="SA">Saudi Arabia</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="city" class="form-label required-field"
                      >City/Governorate</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="city"
                      placeholder="Enter your city"
                      required
                    />
                  </div>
                </div>

                <div class="mb-3">
                  <label for="address" class="form-label required-field"
                    >Address</label
                  >
                  <textarea
                    class="form-control"
                    id="address"
                    rows="2"
                    placeholder="Enter your full address"
                    required
                  ></textarea>
                </div>

                <div class="mb-3">
                  <label for="orderNotes" class="form-label"
                    >Order Notes
                    <small class="text-muted">(Optional)</small></label
                  >
                  <textarea
                    class="form-control"
                    id="orderNotes"
                    rows="2"
                    placeholder="Special instructions for delivery or preparation"
                  ></textarea>
                </div>

                <div class="security-notice">
                  <i class="fas fa-shield-alt"></i>
                  <span
                    >Your personal data will be used to process your order,
                    support your experience, and for other purposes described in
                    our privacy policy.</span
                  >
                </div>
                <!-- Shipping mode selection -->
                <div class="col-12 col-lg-7 mb-4 mb-lg-0">
                  <h2 class="shipping-title">Choose shipping mode</h2>
                  <div class="shipping-options p-3 bg-white rounded-3">
                    <div class="form-check mb-3">
                      <input
                        class="form-check-input shipping-mode"
                        type="radio"
                        name="shipping-mode"
                        id="shipping-mode-1"
                      />
                      <label class="form-check-label" for="shipping-mode-1">
                        <span class="fw-bold">Store pickup</span> (In 20 min) ‚Ä¢
                        <span class="text-success">FREE</span>
                      </label>
                    </div>
                    <div class="form-check">
                      <input
                        class="form-check-input shipping-mode"
                        type="radio"
                        name="shipping-mode"
                        id="shipping-mode-2"
                      />
                      <label class="form-check-label" for="shipping-mode-2">
                        <span class="fw-bold">Delivery at home</span> ‚Ä¢
                        <span class="text-danger">$50.00</span>
                      </label>
                    </div>
                  </div>
                </div>
                <div class="mt-4">
                  <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="fas fa-credit-card me-2"></i> Continue to Payment
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Help Section -->
          <div class="help-section">
            <h5><i class="fas fa-question-circle"></i> Need Help?</h5>
            <div class="help-item">
              <div class="help-icon">
                <i class="fas fa-phone"></i>
              </div>
              <div class="help-text">
                <h6>Call Us</h6>
                <p>Our customer support is available 24/7 at +20 123 456 789</p>
              </div>
            </div>
            <div class="help-item">
              <div class="help-icon">
                <i class="fas fa-truck"></i>
              </div>
              <div class="help-text">
                <h6>Shipping Questions</h6>
                <p>Get information about delivery times and tracking</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Summary Section -->
        <div class="col-lg-5">
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-shopping-bag"></i> Your Order</h3>
            </div>
            <div class="card-body p-4">
              <div class="order-summary">
                <h5>Order Summary</h5>
                <div id="productList">
                  <!-- Products will be inserted here by JavaScript -->
                </div>

                <div class="summary-divider"></div>

                <div class="summary-row">
                  <span>Subtotal</span>
                  <span id="subTotal">$0.00</span>
                </div>
                <div class="summary-row">
                  <span>Shipping</span>
                  <span id="shipping">$50.00</span>
                </div>

                <div class="summary-divider"></div>

                <div class="summary-row total-price">
                  <span>Total</span>
                  <span id="total">$0.00</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div
        id="messageBox"
        style="color: red; margin-top: 10px; font-weight: bold"
      ></div>
    </div>

    <!-- Footer -->
    <footer class="footer text-white pt-5 pb-3">
      <div class="container">
        <div class="d-flex flex-column flex-md-row text-center text-md-start">
          <!-- Brand / About -->
          <div class="flex-fill px-3 mb-4 mb-md-0">
            <h5 class="text-uppercase text-center text-md-start">Legatus</h5>
            <p class="small text-white">
              Discover timeless elegance with our curated selection of luxury
              watches from top global brands.
            </p>
          </div>

          <!-- Quick Links -->
          <div class="flex-fill px-3 mb-4 mb-md-0">
            <h6 class="text-uppercase mb-3 text-center text-md-start">
              Quick Links
            </h6>
            <ul class="list-unstyled small">
              <li>
                <a href="index.html" class="text-white text-decoration-none"
                  >Home</a
                >
              </li>
              <li>
                <a
                  href="productCatalog.html"
                  class="text-white text-decoration-none"
                  >Shop</a
                >
              </li>
              <li>
                <a href="ContactUs.html" class="text-white text-decoration-none"
                  >Contact</a
                >
              </li>
            </ul>
          </div>

          <!-- Contact Info -->
          <div class="flex-fill px-3">
            <h6 class="text-uppercase mb-3 text-center text-md-start">
              Contact Us
            </h6>
            <p class="small text-white mb-1">üìç 123 Luxury Ave, Cairo, Egypt</p>
            <p class="small text-white mb-1">üìû +20 123 456 789</p>
            <p class="small text-white mb-3">‚úâ info@legatus.com</p>
            <div
              class="d-flex justify-content-center justify-content-md-start gap-3"
            >
              <a href="#" class="text-white fs-5"
                ><i class="bi bi-facebook"></i
              ></a>
              <a href="#" class="text-white fs-5"
                ><i class="bi bi-instagram"></i
              ></a>
              <a href="#" class="text-white fs-5"
                ><i class="bi bi-twitter"></i
              ></a>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Function to generate a unique order ID
      function generateOrderId() {
        const timestamp = new Date().getTime();
        const random = Math.floor(Math.random() * 100000)
          .toString()
          .padStart(5, "0");
        const orderId = `ORD-${timestamp}-${random}`;
        return orderId;
      }
      
function manageInventory() {
  // 1. Get checkout data from localStorage
  const checkoutData = localStorage.getItem("checkout");
  if (!checkoutData) {
    console.log("No checkout data found");
    return;
  }

  // 2. Get products inventory from localStorage
  const productsData = localStorage.getItem("products");
  if (!productsData) {
    console.log("No products inventory data found");
    return;
  }

  try {
    // Parse the data
    let checkoutProducts = JSON.parse(checkoutData);
    let inventoryProducts = JSON.parse(productsData);
    
    // Normalize checkout data structure
    if (checkoutProducts.products && Array.isArray(checkoutProducts.products)) {
      checkoutProducts = checkoutProducts.products;
    }
    
    // Make sure we have arrays
    if (!Array.isArray(checkoutProducts)) {
      checkoutProducts = [checkoutProducts];
    }
    
    if (!Array.isArray(inventoryProducts)) {
      inventoryProducts = [inventoryProducts];
    }
    
    console.log("Checkout products:", checkoutProducts);
    console.log("Inventory products:", inventoryProducts);
    
    // 3. Compare products and update inventory
    let updatedInventory = inventoryProducts.map(inventoryItem => {
      const inventoryId = inventoryItem.id || inventoryItem.productId;
      
      // Find matching product in checkout
      const checkoutItem = checkoutProducts.find(checkoutProduct => {
        // Handle nested product structure
        const product = checkoutProduct.product || checkoutProduct;
        const checkoutId = product.id || product.productId;
        return checkoutId === inventoryId;
      });
      
      // If product found in checkout, update inventory
      if (checkoutItem) {
        const product = checkoutItem.product || checkoutItem;
        const requestedQuantity = parseInt(product.quantity_in_cart || product.quantity || 1);
        const currentStock = parseInt(inventoryItem.stock || 0);
        
        // 4. Check if stock > 0
        if (currentStock > 0) {
          // 5. Check if stock > quantity
          if (currentStock >= requestedQuantity) {
            // If we have enough stock, reduce it by requested quantity
            inventoryItem.stock = currentStock - requestedQuantity;
          } else {
            // 6. If we don't have enough stock, set to 0 and adjust checkout quantity
            const remainingQuantity = requestedQuantity - currentStock;
            inventoryItem.stock = 0;
            
            // Update checkout item quantity
            if (checkoutItem.product) {
              // Handle nested product structure
              checkoutItem.product.quantity = remainingQuantity;
              checkoutItem.product.quantity_in_cart = remainingQuantity;
            } else {
              // Direct product object
              checkoutItem.quantity = remainingQuantity;
              checkoutItem.quantity_in_cart = remainingQuantity;
            }
          }
        }
      }
      
      return inventoryItem;
    });
    
    // 6. Update localStorage with new inventory
    localStorage.setItem("products", JSON.stringify(updatedInventory));
    
    // Also update checkout data if quantities were adjusted
    localStorage.setItem("checkout", JSON.stringify(checkoutProducts));
    
    console.log("Inventory updated successfully");
    return updatedInventory;
  } catch (e) {
    console.error("Error managing inventory:", e);
  }
}


      function createOrder() {
        const orderId = generateOrderId();
        const productsData = getProductsFromStorage();
        console.log("Retrieved data:", productsData);
    
        // Try to get userId from localStorage directly first
        //let userId = localStorage.getItem("currentUserId") || "guest-user";
        const currentUser = JSON.parse(localStorage.getItem("currentUser")||"{}");
        let UserId = currentUser.id;
        let sellerId = "unknown-seller";
        let total = 0;
    
        if (productsData && Array.isArray(productsData) && productsData.length > 0) {
          // Still try to get userId from product data as backup
          if (productsData[0].userId) {
            userId = productsData[0].userId;
          } else if (productsData[0].product && productsData[0].product.userId) {
            // Check nested product structure
            userId = productsData[0].product.userId;
          }
          
          total = 0;
          for (let i = 0; i < productsData.length; i++) {
            const productContainer = productsData[i];
    
            if (productContainer.product) {
              const product = productContainer.product;
    
              if (i === 0 && product.sellerId) {
                sellerId = product.sellerId;
              }
    
              const price = parseFloat(product.price || 0);
              const quantity = parseInt(product.quantity || 1);
              total += price * quantity;
            } else {
              if (i === 0 && productContainer.sellerId) {
                sellerId = productContainer.sellerId;
              }
    
              const price = parseFloat(productContainer.price || 0);
              const quantity = parseInt(productContainer.quantity || 1);
              total += price * quantity;
            }
          }
        }
    
        console.log("Extracted userId:", userId);
        console.log("Extracted sellerId:", sellerId);
        console.log("Calculated total:", total);
    
        // Get the selected shipping mode
        const storePickupRadio = document.getElementById("shipping-mode-1");
        // Determine shipping cost based on selected shipping method
        const shipping = storePickupRadio && storePickupRadio.checked ? 0 : 50;
        const totalAmount = total + shipping;
        const shippingMethod =
          storePickupRadio && storePickupRadio.checked
            ? "Store Pickup"
            : "Delivery at Home";
    
        const order = {
          orderId: orderId,
          userId: userId,
          sellerId: sellerId,
          products: productsData,
          orderDate: new Date().toISOString(),
          subtotal: total.toFixed(2),
          shipping: shipping.toFixed(2),
          totalAmount: totalAmount.toFixed(2),
          shippingMethod: shippingMethod,
          status: "paid",
        };
    
        saveOrderToStorage(order);
        return order;
      }
    
      // Function to ensure proper user ID propagation from Cart to Checkout
      function propagateUserIdToCheckout(checkoutData) {
        const cartData = localStorage.getItem("Cart");
        const currentUserData =localStorage.getItem("currentUser");
        
        if (cartData && currentUserData) {
          try {
            let cartProducts = JSON.parse(cartData);
            let cuurentUser =JSON.parse(currentUserData);
            let currentUserId = cuurentUser.id;
            // Extract userId from cart data
            let userId = "guest-user";
            if (Array.isArray(cartProducts)) {
              const matchedItem = cartProducts.find(item => item.userId === currentUserId);
              if (matchedItem) {
                userId = matchedItem.userId;
              }
            }
            if (checkoutData) {
              if (Array.isArray(checkoutData)) {
                checkoutData.forEach(product => {
                  product.userId = userId;
                });
              } else if (checkoutData.products && Array.isArray(checkoutData.products)) {
                checkoutData.userId = userId;
                checkoutData.products.forEach(product => {
                  product.userId = userId;
                });
              } else {
                checkoutData.userId = userId;
              }
        localStorage.setItem("checkout", JSON.stringify(checkoutData));
      }
            
            return checkoutData;
          } catch (e) {
            console.error("Error propagating userId to checkout:", e);
          }
        }
        
        return checkoutData;
      }
    
      // This function should be called when moving items from Cart to checkout
      function moveCartToCheckout() {
        const cartData = localStorage.getItem("Cart");
        
        if (cartData) {
          try {
            const parsedCartData = JSON.parse(cartData);
            
            // Make sure userId is propagated to checkout
            const checkoutData = propagateUserIdToCheckout(parsedCartData);
            
            // Save to checkout storage
            localStorage.setItem("checkout", JSON.stringify(checkoutData));
            
            console.log("Cart data moved to checkout with userId preserved");
          } catch (e) {
            console.error("Error moving cart to checkout:", e);
          }
        }
      }
    
      document.getElementById('phoneNumber').addEventListener('input', function (e) {
        this.value = this.value.replace(/\D/g, ''); // Remove non-digits
      });
    
      function getProductsFromStorage() {
        // Only read from checkout data, not Cart
        const checkoutData = localStorage.getItem("checkout");
        console.log("Raw checkout data:", checkoutData);
    
        let parsedCheckoutData = [];
        if (checkoutData) {
          try {
            parsedCheckoutData = JSON.parse(checkoutData);
            console.log("Parsed checkout data:", parsedCheckoutData);
    
            // Handle case where the data might be wrapped in another object
            if (
              parsedCheckoutData.products &&
              Array.isArray(parsedCheckoutData.products)
            ) {
              console.log("Found products array inside checkout data");
              parsedCheckoutData = parsedCheckoutData.products;
            }
    
            // Make sure we have an array
            if (!Array.isArray(parsedCheckoutData)) {
              console.log("Converting non-array checkout data to array");
              parsedCheckoutData = [parsedCheckoutData];
            }
            
            // Ensure userId propagation
            parsedCheckoutData = propagateUserIdToCheckout(parsedCheckoutData);
          } catch (e) {
            console.error("Failed to parse checkout data:", e);
          }
        } else {
          console.log("No checkout data found in localStorage");
        }
    
        return parsedCheckoutData;
      }
    
      function saveOrderToStorage(order) {
        const existingOrders = JSON.parse(localStorage.getItem("Orders")) || [];
        existingOrders.push(order);
        localStorage.setItem("Orders", JSON.stringify(existingOrders));
        
        // Clear temporary userId storage
        //localStorage.removeItem("currentUserId");
      }
      
      // Function to compare Cart and checkout products and clear storage appropriately
      function compareCartAndCheckout() {
        // Get data from both storages
        const cartData = localStorage.getItem("Cart");
        const checkoutData = localStorage.getItem("checkout");
        const currentUser =JSON.parse(localStorage.getItem("currentUser")||"{}");
        const currentUserId=currentUser.id;
    
        console.log("Cart data:", cartData);
        console.log("Checkout data:", checkoutData);
    
        // If either storage is empty, just clear checkout
        if (!cartData || !checkoutData||!currentUserId) {
          console.log(
            "Either Cart or checkout is empty. Clearing only checkout."
          );
          localStorage.removeItem("checkout");
          return;
        }
    
        try {
          // Parse the data
          let cartProducts = JSON.parse(cartData);
          let checkoutProducts = JSON.parse(checkoutData);
    
          // Normalize the data structures
          // Handle case where data might be wrapped in another object
          if (cartProducts.products && Array.isArray(cartProducts.products)) {
            cartProducts = cartProducts.products;
          }
    
          if (
            checkoutProducts.products &&
            Array.isArray(checkoutProducts.products)
          ) {
            checkoutProducts = checkoutProducts.products;
          }
    
          // Make sure we have arrays
          if (!Array.isArray(cartProducts)) {
            cartProducts = [cartProducts];
          }
    
          if (!Array.isArray(checkoutProducts)) {
            checkoutProducts = [checkoutProducts];
          }
    
          console.log("Normalized cart products:", cartProducts);
          console.log("Normalized checkout products:", checkoutProducts);

          const userCart = cartProducts.filter(p =>p.userId === currentUserId);
          const userCheckout = checkoutProducts.filter(p=>p.userId===currentUserId);

          const cartProductIds= extractProductIds(userCart);
          const checkoutProductIds = extractProductIds(userCheckout);
    
          // Check if all products in checkout are in cart
          const areAllCheckoutProductsInCart = checkoutProductIds.every((id) =>
            cartProductIds.includes(id)
          );
    
          // Check if all products in cart are in checkout
          const areAllCartProductsInCheckout = cartProductIds.every((id) =>
            checkoutProductIds.includes(id)
          );
    
          // If the product IDs match in both directions, clear both storages
          if (
            areAllCheckoutProductsInCart &&
            areAllCartProductsInCheckout &&
            cartProductIds.length === checkoutProductIds.length
          ) {
            console.log("User's cart matches checkout. Removing only their cart items.");

            // Remove only current user's cart items
            const remainingCart = cartProducts.filter(p => p.userId !== currentUserId);

            if (remainingCart.length > 0) {
              localStorage.setItem("Cart", JSON.stringify(remainingCart));
            } else {
              localStorage.removeItem("Cart");
            }

            localStorage.removeItem("checkout");
            } else {
            console.log("Products don't match. Clearing only checkout.");
            localStorage.removeItem("checkout");
            }

            } catch (e) {
            console.error("Error comparing Cart and checkout:", e);
            localStorage.removeItem("checkout");
        }
      }
    
      // Helper function to extract product IDs from product arrays
      function extractProductIds(products) {
        const productIds = [];
    
        products.forEach((productContainer) => {
          let product;
    
          if (productContainer.product) {
            // Structure: { product: {...} }
            product = productContainer.product;
          } else {
            // Direct product object
            product = productContainer;
          }
    
          // Add the product ID to our array if it exists
          if (product.id) {
            productIds.push(product.id);
          } else if (product.productId) {
            productIds.push(product.productId);
          }
        });
    
        return productIds;
      }
      
      // Display products when the page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Get shipping mode radio buttons
        const storePickupRadio = document.getElementById("shipping-mode-1");
        const homeDeliveryRadio = document.getElementById("shipping-mode-2");
    
        // Set default selected shipping option (home delivery)
        if (homeDeliveryRadio) {
          homeDeliveryRadio.checked = true;
        }
    
        // Add event listeners to shipping mode options
        if (storePickupRadio) {
          storePickupRadio.addEventListener("change", function () {
            const products = getProductsFromStorage();
            displayProducts(products);
          });
        }
    
        if (homeDeliveryRadio) {
          homeDeliveryRadio.addEventListener("change", function () {
            const products = getProductsFromStorage();
            displayProducts(products);
          });
        }
    
        const products = getProductsFromStorage();
        displayProducts(products);
    
        // Form submission handler
        const checkoutForm = document.getElementById("checkoutForm");
        if (checkoutForm) {
          checkoutForm.addEventListener("submit", function (event) {
            event.preventDefault();
    
            if (this.checkValidity()) {
              //let userId = localStorage.getItem("currentUserId") || "guest-user";
              const currentUser = localStorage.getItem("currentUser")||"{}";
              let userId = currentUser.id;
              const products = getProductsFromStorage();
              if (products && products.length > 0) {
                // Use userId from products only if not already set
                if (userId === "guest-user" && products[0].userId) {
                  userId = products[0].userId;
                }
              } else {
                const messageBox = document.getElementById("messageBox");
                if (messageBox) {
                  messageBox.innerText = "‚ö†Ô∏è Please add items to your cart.";
                  messageBox.style.display = "block";
                }
                return;
              }
              manageInventory();
              const order = createOrder();
              console.log("Order created:", order);
    
              const formData = {
                customer: {
                  fullName: document.getElementById("fullName").value,
                  phoneNumber: document.getElementById("phoneNumber").value,
                  country:
                    document.getElementById("country").options[
                      document.getElementById("country").selectedIndex
                    ].text,
                  city: document.getElementById("city").value,
                  address: document.getElementById("address").value,
                  orderNotes: document.getElementById("orderNotes").value,
                },
                orderId: order.orderId,
              };
    
              localStorage.setItem("orderData", JSON.stringify(formData));
    
              // Compare Cart and checkout before redirecting
              compareCartAndCheckout();
    
              window.location.href = "confirmation.html";
            } else {
              this.classList.add("was-validated");
            }
          });
        }
      });
    
      function displayProducts(productsData) {
        const productList = document.getElementById("productList");
        if (!productList) return;
    
        productList.innerHTML = "";
    
        let subtotal = 0;
    
        if (!productsData || productsData.length === 0) {
          productList.innerHTML =
            '<p class="text-muted">No products in your cart</p>';
          updateOrderSummary(0);
          return;
        }
    
        console.log("Displaying products:", productsData);
    
        productsData.forEach((productContainer) => {
          let product;
          let quantity;
          let price;
    
          // Log the structure of each product container for debugging
          console.log("Processing product container:", productContainer);
    
          if (productContainer.product) {
            // Structure: { product: {...} }
            product = productContainer.product;
            quantity = parseInt(
              product.quantity_in_cart || product.quantity || 1
            );
            price = parseFloat(product.price || 0);
          } else {
            // Direct product object
            product = productContainer;
            quantity = parseInt(
              product.quantity_in_cart || product.quantity || 1
            );
            price = parseFloat(product.price || 0);
          }
    
          // Additional check for valid price and quantity
          if (isNaN(price)) price = 0;
          if (isNaN(quantity)) quantity = 1;
    
          const itemTotal = price * quantity;
          subtotal += itemTotal;
    
          const name = product.name || "Product";
          const imageUrl = product.image || "/api/placeholder/70/70";
    
          const productItem = document.createElement("div");
          productItem.className = "product-item";
          productItem.innerHTML = `
                    <img src="${imageUrl}" alt="${name}" class="product-image">
                    <div class="product-details">
                        <h6>${name}</h6>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Qty: ${quantity} √ó ${price.toFixed(
            2
          )}</span>
                            <strong class="text-primary">${itemTotal.toFixed(
                              2
                            )}</strong>
                        </div>
                    </div>
                `;
          productList.appendChild(productItem);
        });
    
        updateOrderSummary(subtotal);
      }
    
      function updateOrderSummary(subtotal) {
        // Get the selected shipping mode
        const storePickupRadio = document.getElementById("shipping-mode-1");
        // Determine shipping cost based on selected option
        const shipping = storePickupRadio && storePickupRadio.checked ? 0 : 50;
    
        const total = subtotal + shipping;
    
        const subTotalElement = document.getElementById("subTotal");
        const shippingElement = document.getElementById("shipping");
        const totalElement = document.getElementById("total");
    
        if (subTotalElement) {
          subTotalElement.textContent = `$${subtotal.toFixed(2)}`;
        }
    
        if (shippingElement) {
          shippingElement.textContent = `$${shipping.toFixed(2)}`;
        }
    
        if (totalElement) {
          totalElement.textContent = `$${total.toFixed(2)}`;
        }
      }
    </script>
  </body>
</html>
